<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using the DAQ with Bluesky &mdash; pcdsdaq 2.4.3.dev6+g22ad154 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=25d93aeb"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Preprocessors API" href="preprocessors_api.html" />
    <link rel="prev" title="pcdsdaq.ami.concat_filter_strings" href="generated/pcdsdaq.ami.concat_filter_strings.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdsdaq
          </a>
              <div class="version">
                2.4.3.dev6+g22ad154
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Running the DAQ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="daq_basic.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="daq_config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="daq_api.html">Daq API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting AMI Data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ami_basic.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="ami_api.html">AmiDet API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Bluesky Plans</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using the DAQ with Bluesky</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-daq-object-with-the-runengine">Creating a Daq object with the RunEngine</a></li>
<li class="toctree-l2"><a class="reference internal" href="#calib-cycles">Calib Cycles</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-with-the-sequencer">Running with the Sequencer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-for-an-entire-plan-duration">Running for an Entire Plan Duration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#after-the-plan">After the Plan</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="preprocessors_api.html">Preprocessors API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Auxiliary Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="scan_pvs.html">Scan PVs</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Miscellaneous</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Sim Mode</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="sim.html">Simulated DAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="env.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdsdaq</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Using the DAQ with Bluesky</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/plans_basic.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="using-the-daq-with-bluesky">
<h1>Using the DAQ with Bluesky<a class="headerlink" href="#using-the-daq-with-bluesky" title="Link to this heading">¶</a></h1>
<p>The <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a> class is designed as a drop-in <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> readable. That means
you can put it into built-in <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> plans in the <code class="docutils literal notranslate"><span class="pre">dets</span></code> list and it will
collect data at each scan point.</p>
<p>This document will assume some familiarity with <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> and
how to use the <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code>, but does not require a full understanding of
the internals.</p>
<section id="creating-a-daq-object-with-the-runengine">
<h2>Creating a Daq object with the RunEngine<a class="headerlink" href="#creating-a-daq-object-with-the-runengine" title="Link to this heading">¶</a></h2>
<p>The <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a> needs to register a <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code> instance for this to work. This
must be the same <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code> that will be running all of the plans.
This will be done automatically for you in a <code class="docutils literal notranslate"><span class="pre">hutch-python</span></code> session.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">RunEngine</span>
<span class="kn">from</span> <span class="nn">pcdsdaq.daq</span> <span class="kn">import</span> <span class="n">Daq</span>
<span class="kn">from</span> <span class="nn">pcdsdaq.sim</span> <span class="kn">import</span> <span class="n">set_sim_mode</span>

<span class="n">set_sim_mode</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">daq</span> <span class="o">=</span> <span class="n">Daq</span><span class="p">(</span><span class="n">RE</span><span class="o">=</span><span class="n">RE</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">daq</span></code> object must be staged if it’s going to be used in a plan. This
is done automatically in <a class="reference internal" href="generated/pcdsdaq.preprocessors.daq_during_wrapper.html#pcdsdaq.preprocessors.daq_during_wrapper" title="pcdsdaq.preprocessors.daq_during_wrapper"><code class="xref any py py-func docutils literal notranslate"><span class="pre">daq_during_wrapper</span></code></a>, <a class="reference internal" href="generated/pcdsdaq.preprocessors.daq_during_decorator.html#pcdsdaq.preprocessors.daq_during_decorator" title="pcdsdaq.preprocessors.daq_during_decorator"><code class="xref any py py-func docutils literal notranslate"><span class="pre">daq_during_decorator</span></code></a>, and
in most built-in plans like <code class="docutils literal notranslate"><span class="pre">count</span></code> and <code class="docutils literal notranslate"><span class="pre">scan</span></code>.</p>
</div>
</section>
<section id="calib-cycles">
<h2>Calib Cycles<a class="headerlink" href="#calib-cycles" title="Link to this heading">¶</a></h2>
<p>Including calib cycles in a built-in plan is as simple as including the <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a>
as a reader or detector. The <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a> will start and run for the configured
duration or number of events at every scan step.</p>
<p>The built-in <code class="docutils literal notranslate"><span class="pre">scan</span></code> will move <code class="docutils literal notranslate"><span class="pre">motor1</span></code> from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">10</span></code> in <code class="docutils literal notranslate"><span class="pre">11</span></code>
steps. Prior to the scan, we configure the <code class="docutils literal notranslate"><span class="pre">daq</span></code> to take <code class="docutils literal notranslate"><span class="pre">120</span></code> events at
each point. Since <code class="docutils literal notranslate"><span class="pre">daq</span></code> is included in the detectors list, it is run at every
step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">scan</span>
<span class="n">daq</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">events</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">daq</span><span class="p">],</span> <span class="n">motor1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="running-with-the-sequencer">
<h2>Running with the Sequencer<a class="headerlink" href="#running-with-the-sequencer" title="Link to this heading">¶</a></h2>
<p>If the daq or the sequencer is configured to run forever, and the other is
configured for a fixed duration or number of events, you can use a normal
daq/sequencer procedure. Each of these devices will wait for the other to
complete when used in a scan in this way.</p>
<p>If the daq is configured to run forever, and the event sequencer has a fixed
run, then we will be executing an event sequencer-controlled plan. At each scan
step, we will start the daq, start the sequencer, wait for the sequencer, and
stop the daq.</p>
<p>If the sequencer is configured to run forever and the daq has a fixed run, then
we will be executing a daq-controlled plan. At each scan step, we will start
the daq, start the sequencer, wait for the daq, and let the sequencer go until
restarting at the next scan step.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">daq</span><span class="p">,</span> <span class="n">sequencer</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="running-for-an-entire-plan-duration">
<h2>Running for an Entire Plan Duration<a class="headerlink" href="#running-for-an-entire-plan-duration" title="Link to this heading">¶</a></h2>
<p>The simplest way to include the daq is to turn it on at the start of the plan
and turn it off at the end of the plan. This is done using the
<a class="reference internal" href="generated/pcdsdaq.preprocessors.daq_during_wrapper.html#pcdsdaq.preprocessors.daq_during_wrapper" title="pcdsdaq.preprocessors.daq_during_wrapper"><code class="xref any py py-func docutils literal notranslate"><span class="pre">daq_during_wrapper</span></code></a> or <a class="reference internal" href="generated/pcdsdaq.preprocessors.daq_during_decorator.html#pcdsdaq.preprocessors.daq_during_decorator" title="pcdsdaq.preprocessors.daq_during_decorator"><code class="xref any py py-func docutils literal notranslate"><span class="pre">daq_during_decorator</span></code></a>, which treat
the <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a> as a <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> <code class="docutils literal notranslate"><span class="pre">Flyer</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plan_stubs</span> <span class="kn">import</span> <span class="n">mv</span>
<span class="kn">from</span> <span class="nn">bluesky.preprocessors</span> <span class="kn">import</span> <span class="n">run_decorator</span>
<span class="kn">from</span> <span class="nn">pcdsdaq.preprocessors</span> <span class="kn">import</span> <span class="n">daq_during_decorator</span>

<span class="nd">@daq_during_decorator</span><span class="p">()</span>
<span class="nd">@run_decorator</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">basic_plan</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
</pre></div>
</div>
<p>This plan will start the <a class="reference internal" href="daq_api.html#pcdsdaq.daq.Daq" title="pcdsdaq.daq.Daq"><code class="xref any py py-class docutils literal notranslate"><span class="pre">Daq</span></code></a>, move <code class="docutils literal notranslate"><span class="pre">motor</span></code> to the <code class="docutils literal notranslate"><span class="pre">start</span></code>, <code class="docutils literal notranslate"><span class="pre">end</span></code>,
and back to the <code class="docutils literal notranslate"><span class="pre">start</span></code> positions, and then end the run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">basic_plan</span><span class="p">(</span><span class="n">motor1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>If you ignore the <a class="reference internal" href="generated/pcdsdaq.preprocessors.daq_during_decorator.html#pcdsdaq.preprocessors.daq_during_decorator" title="pcdsdaq.preprocessors.daq_during_decorator"><code class="xref any py py-func docutils literal notranslate"><span class="pre">daq_during_decorator</span></code></a>, this is just a normal <code class="docutils literal notranslate"><span class="pre">plan</span></code>.
This makes it simple to add the daq collecting data in the background
to a normal <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> <code class="docutils literal notranslate"><span class="pre">plan</span></code>.</p>
</section>
<section id="after-the-plan">
<h2>After the Plan<a class="headerlink" href="#after-the-plan" title="Link to this heading">¶</a></h2>
<p>The daq will automatically be returned to whatever state it was in before
running the <code class="docutils literal notranslate"><span class="pre">bluesky</span></code> <code class="docutils literal notranslate"><span class="pre">plan</span></code>. This means if you start from a disconnected
state, we will disconnect, if you start from a running state we will return
to running, and if you start from a configured state we’ll stay connected.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="generated/pcdsdaq.ami.concat_filter_strings.html" class="btn btn-neutral float-left" title="pcdsdaq.ami.concat_filter_strings" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="preprocessors_api.html" class="btn btn-neutral float-right" title="Preprocessors API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>